{% extends "base.html" %}
{% block title %}Result - Fish Counting App{% endblock %}

{% block content %}
<div class="row mb-4 justify-content-center">
  <!-- <div class="col-md-6">
    <div class="card p-2 mb-3">
      <h5 class="text-center">Original Image</h5>
      <img src="{{ url_for('uploaded_file', filename=original_image) }}" class="img-fluid rounded">
    </div>
  </div> -->
  <div class="col-md-6">
    <div class="card p-2 mb-3">
      <h5 class="text-center">Predicted Image</h5>
      <img src="{{ url_for('predicted_file', filename=predicted_image) }}" class="img-fluid rounded">
    </div>
  </div>
</div>

<!-- Summary Card -->
<div class="row mb-4 justify-content-center">
  <div class="col-md-8">
    <div class="card text-center p-4 shadow-sm">
      <h3>Fish Detected: <strong>{{ total_fish }}</strong></h3>
      <p class="mb-0">Processed at <strong>{{ timestamp }}</strong></p>
    </div>
  </div>
</div>

<!-- Species Breakdown -->
{% if species_counts %}
<div class="row mb-5 justify-content-center">
  <div class="col-md-10">

    <div class="card p-4 shadow mt-4">
  <h4 class="mb-3">Species-wise Detection</h4>
  <div style="height: 400px; position: relative;">
    <canvas id="speciesChart"></canvas>
  </div>
</div>


  </div>
</div>
{% endif %}

<!-- Info -->
<div class="row justify-content-center">
  <div class="col-md-10">
    <div class="card p-4 shadow">
      <h4 class="mb-3">How It Works</h4>
      <p>This application uses advanced <strong>YOLOv8</strong> architecture to detect and count fish in your images. It has been trained on 13 different species, offering reliable predictions in varied underwater conditions.</p>
      <p>For best results, upload well-lit and high-resolution images.</p>
      <div class="text-center mt-4">
        <a href="{{ url_for('index') }}" class="btn btn-primary btn-lg">Upload Another Image</a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const speciesData = {{ species_counts | tojson | safe }};
    const labels = Object.keys(speciesData);
    const data = Object.values(speciesData);

    console.log("Chart Data:", speciesData);

    const backgroundColors = labels.map((_, i) => {
      const colors = [
        'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
        'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
        'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)', 'rgba(0, 191, 255, 0.7)',
        'rgba(255, 99, 71, 0.7)', 'rgba(60, 179, 113, 0.7)', 'rgba(255, 140, 0, 0.7)',
        'rgba(123, 104, 238, 0.7)'
      ];
      return colors[i % colors.length];
    });

    const ctx = document.getElementById('speciesChart').getContext('2d');
    if (Chart.getChart("speciesChart")) {
      Chart.getChart("speciesChart").destroy();
    }

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          data: data,
          backgroundColor: backgroundColors,
          borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            ticks: {
              maxRotation: 45,
              minRotation: 30
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        },
        plugins: {
          legend: {
            display: false  // hides the "Detected Count" legend
          }
        }
      }
    });
  });
</script>
{% endblock %}
